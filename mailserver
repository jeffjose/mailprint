#!/bin/bash

# Wrapper script for mailserver.py that handles uv with sudo

# Function to find uv
find_uv() {
    # Check if uv is in PATH
    if command -v uv &> /dev/null; then
        command -v uv
        return 0
    fi
    
    # When running as root, check the sudo user's home
    if [ -n "$SUDO_USER" ] && [ -f "/home/$SUDO_USER/.local/bin/uv" ]; then
        echo "/home/$SUDO_USER/.local/bin/uv"
        return 0
    fi
    
    # Search in all home directories for .local/bin/uv
    for home_dir in /home/*; do
        if [ -f "$home_dir/.local/bin/uv" ]; then
            echo "$home_dir/.local/bin/uv"
            return 0
        fi
    done
    
    # Check common system locations
    for path in /usr/local/bin/uv /usr/bin/uv /opt/uv/bin/uv; do
        if [ -f "$path" ]; then
            echo "$path"
            return 0
        fi
    done
    
    return 1
}

# Find uv
UV_PATH=$(find_uv)

if [ -z "$UV_PATH" ]; then
    echo "Error: uv not found in common locations."
    if [ "$EUID" -eq 0 ]; then
        echo "Try running: sudo -E env PATH=\$PATH $0 $@"
    else
        echo "Please install uv or add it to your PATH."
    fi
    exit 1
fi

# Run the mailserver with uv
"$UV_PATH" run "$(dirname "$0")/mailserver.py" "$@"