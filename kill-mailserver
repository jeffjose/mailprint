#!/bin/bash

# Kill all mailserver instances

# Check if running as root
if [ "$EUID" -ne 0 ]; then 
    echo "âš ï¸  Please run with sudo: sudo $0"
    exit 1
fi

echo "ðŸ” Finding mail server processes..."

# Kill all processes containing mailserver in command line
for pid in $(ps aux | grep -E 'mailserver|simple_mailserver|working_tls_server|tls_mailserver' | grep -v grep | awk '{print $2}'); do
    echo "  Killing PID $pid"
    kill -9 $pid 2>/dev/null
done

# Kill uv processes running mailserver
pkill -9 -f "uv.*mailserver" 2>/dev/null
pkill -9 -f "uv run.*mailserver" 2>/dev/null

# Kill Python processes running mailserver
pkill -9 -f "python.*mailserver" 2>/dev/null
pkill -9 -f "python3.*mailserver" 2>/dev/null

# Also kill any processes on mail ports
for port in 25 587 2525; do
    pid=$(ss -tlnp 2>/dev/null | grep ":$port" | grep -oP '(?<=pid=)\d+' | head -1)
    if [ ! -z "$pid" ]; then
        echo "  Killing process $pid on port $port"
        kill -9 $pid 2>/dev/null
    fi
done

echo "âœ… All mail server processes killed"

# Verify no processes are listening on mail ports
echo ""
echo "ðŸ“‹ Checking mail ports:"
for port in 25 587 2525; do
    if ss -tlnp 2>/dev/null | grep -q ":$port"; then
        echo "  âš ï¸  Port $port is still in use"
        ss -tlnp 2>/dev/null | grep ":$port"
    else
        echo "  âœ“ Port $port is free"
    fi
done